name: RDP

on:
  workflow_dispatch:
    inputs:
      # يمكنك تغيير القيمة الافتراضية هنا أو تركها فارغة واستخدام secret بدلًا منها.
      password:
        description: 'Optional: RDP password. Default set by workflow (visible in dispatch UI). For better security put password into repository secret RDP_PASSWORD.'
        required: false
        default: 'B123@bJ2033+'

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure Core RDP Settings
        shell: pwsh
        run: |
          # تفعيل Remote Desktop (fDenyTSConnections = 0)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
            -Name "fDenyTSConnections" -Value 0 -Force

          # تعطيل Network Level Authentication (اختياري حسب حاجتك)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
            -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
            -Name "SecurityLayer" -Value 0 -Force

          # تنظيف أي قاعدة جدار ناري بنفس الاسم ثم إضافة واحدة جديدة تفتح المنفذ 3389
          netsh advfirewall firewall delete rule name="RDP-Tailscale" > $null 2>&1
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=3389

          # إعادة تشغيل خدمة Remote Desktop
          Restart-Service -Name TermService -Force

      - name: Create (or Replace) RDP User with Provided Password
        shell: pwsh
        run: |
          # اختيار كلمة المرور: يأتي أولًا من input، وإذا لم توجد يستخدم الـ secret RDP_PASSWORD (إن وُجد)
          $inputPassword = '${{ github.event.inputs.password }}'
          $secretPassword = '${{ secrets.RDP_PASSWORD }}'
          if ($inputPassword -and $inputPassword.Trim().Length -gt 0) {
              $password = $inputPassword
              Write-Host "Using password from workflow input."
          } elseif ($secretPassword -and $secretPassword.Trim().Length -gt 0) {
              $password = $secretPassword
              Write-Host "Using password from repository secret."
          } else {
              Write-Host "No password supplied via input or secret. Aborting."
              exit 1
          }

          # تحقق بسيط لطول/تعقيد (تعديل حسب حاجتك)
          if ($password.Length -lt 8) {
              Write-Error "Password must be at least 8 characters."
              exit 1
          }

          # حذف المستخدم السابق إن وُجد ثم إنشاء المستخدم الجديد
          if (Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue) {
              Write-Host "User 'RDP' exists — removing."
              Remove-LocalUser -Name "RDP" -ErrorAction SilentlyContinue
          }

          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires -Description "RDP user created by GitHub Actions"
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"

          # خزّن الباسورد في متغير بيئة داخلي لاستخدامه لاحقًا في نفس الـ workflow
          echo "RDP_PASSWORD_STORE=$password" >> $env:GITHUB_ENV

          # تحقق أن المستخدم تم إنشاؤه فعلاً
          if (-not (Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue)) {
              Write-Error "User creation failed"
              exit 1
          } else {
              Write-Host "User 'RDP' created successfully."
          }

 - name: Create info.txt for RDP user (with credentials)
        shell: pwsh
        run: |
          # جلب كلمة المرور من المتغير الداخلي (تم تعيينه سابقًا في Create user step)
          $password = $env:RDP_PASSWORD_STORE
          if (-not $password) {
              # محاولة استخدام secret كنسخة احتياطية
              $password = $env:RDP_PASSWORD
          }

          # اختر مكان الملف: حاول سطح مكتب المستخدم RDP وإلا استخدم C:\Temp
          $userProfile = "C:\Users\RDP"
          $desktopPath = Join-Path $userProfile "Desktop"
          if (Test-Path $desktopPath) {
              $filePath = Join-Path $desktopPath "rdp-info.txt"
          } else {
              # مجلد المستخدم لم يُنشأ بالكامل، نستخدم C:\Temp كحل عملي
              if (-not (Test-Path "C:\Temp")) { New-Item -Path "C:\Temp" -ItemType Directory -Force | Out-Null }
              $filePath = "C:\Temp\rdp-info.txt"
          }

          # هنا-string صحيح (ملاحظة: المتغيرات داخل هنا-string المقتبسة بـ @" "@ سيتم توسعها)
          $content = @"
مرحبا،
هذا ملف يحتوي على معلومات الـ RDP.
Username: RDP
Password: $password
ملاحظة: احذف هذا الملف بعد الانتهاء أو خزّن كلمة المرور في مكان آمن.
          "@

          # كتابة المحتوى (يستبدل الملف إن كان موجوداً)
          Set-Content -Path $filePath -Value $content -Encoding UTF8

          # محاولة ضبط ACL ليصبح الملف مملوكًا لـ RDP فقط (قد تفشل إن لم يكن بروفايل المستخدم مكتمل)
          try {
              $acl = New-Object System.Security.AccessControl.FileSecurity
              $rule = New-Object System.Security.AccessControl.FileSystemAccessRule("RDP","FullControl","Allow")
              $acl.SetOwner([System.Security.Principal.NTAccount]"RDP")
              $acl.SetAccessRule($rule)
              Set-Acl -Path $filePath -AclObject $acl
              Write-Host "File created and ACL set to RDP only: $filePath"
          } catch {
              Write-Warning "Could not fully set ACL; file created at: $filePath"
          }

          # لا نطبع المحتويات الحساسة؛ نطبع فقط المسار
          Write-Host "Created file at: $filePath"

      - name: Install Tailscale
        shell: pwsh
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Establish Tailscale Connection
        shell: pwsh
        env:
          # تأكد من وضع TAILSCALE_AUTH_KEY في Settings -> Secrets -> Actions باسم TAILSCALE_AUTH_KEY
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          if (-not $env:TAILSCALE_AUTH_KEY) {
              Write-Error "Tailscale auth key not found in secrets (TAILSCALE_AUTH_KEY)."
              exit 1
          }

          $tailscaleExe = Join-Path $env:ProgramFiles "Tailscale\tailscale.exe"
          if (-not (Test-Path $tailscaleExe)) {
              Write-Error "tailscale.exe not found after install."
              exit 1
          }

          & $tailscaleExe up --authkey=$env:TAILSCALE_AUTH_KEY --hostname="gh-runner-$env:GITHUB_RUN_ID"
          
          # الانتظار للحصول على IP
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 12) {
              $tsIP = (& $tailscaleExe ip -4).Trim()
              if ($tsIP) { break }
              Start-Sleep -Seconds 5
              $retries++
          }

          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned. Exiting."
              exit 1
          }

          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "Tailscale IP assigned: $tsIP"

      - name: Verify RDP Accessibility
        shell: pwsh
        run: |
          $tsIP = $env:TAILSCALE_IP
          if (-not $tsIP) {
              Write-Error "No Tailscale IP available."
              exit 1
          }

          Write-Host "Testing TCP connectivity to $tsIP:3389 ..."
          $testResult = Test-NetConnection -ComputerName $tsIP -Port 3389 -InformationLevel Quiet
          if (-not $testResult) {
              Write-Error "TCP connection to RDP port 3389 failed"
              exit 1
          }
          Write-Host "TCP connectivity successful!"

      - name: Maintain Connection (show connection details)
        shell: pwsh
        run: |
          $tsIP = $env:TAILSCALE_IP
          $password = $env:RDP_PASSWORD_STORE

          Write-Host "`n=== RDP ACCESS ==="
          Write-Host "Address (Tailscale): $tsIP"
          Write-Host "Username: RDP"
          # هنا نطبع الباسورد لأنك طلبت ذلك صراحةً؛ كُن على علم أن هذا سيظهر في سجلات الـ Actions.
          Write-Host "Password: $password"
          Write-Host "==================`n"

          # حلقة تبقي الـ runner نشطًا (أوقفها يدويًا من واجهة GitHub Actions)
          while ($true) {
              Write-Host "[$(Get-Date -Format o)] RDP Active - Use Cancel workflow to terminate"
              Start-Sleep -Seconds 300
          }
